name: Code Quality

on:
  push:
    branches: [ master, development ]
  pull_request:
    branches: [ master, development ]

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: pdo, pdo_mysql, mbstring, openssl, tokenizer, xml, ctype, json, bcmath
        tools: composer:v2, phpunit

    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install PHP dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Run PHP CodeSniffer
      run: |
        if [ -f vendor/bin/phpcs ]; then
          vendor/bin/phpcs --standard=PSR12 app/ core/ --ignore=vendor/
        else
          echo "PHP CodeSniffer not found, skipping..."
        fi

    - name: Run PHPStan
      run: |
        if [ -f vendor/bin/phpstan ]; then
          vendor/bin/phpstan analyse --configuration=phpstan.neon
        else
          echo "PHPStan not found, skipping..."
        fi

    - name: Run GrumPHP
      run: |
        if [ -f vendor/bin/grumphp ]; then
          vendor/bin/grumphp run
        else
          echo "GrumPHP not found, skipping..."
        fi

    - name: Check for syntax errors
      run: find app/ core/ -name "*.php" -exec php -l {} \; | grep -v "No syntax errors detected" || true